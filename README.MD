# Расширение Berkut Security Search

**Berkut Security Search** — это браузерное расширение для проверки поисковых запросов на соответствие базе данных запрещённых материалов, обеспечивающее соблюдение правил контента. Расширение предоставляет удобный интерфейс для проверки запросов, управления избранными сайтами (плитками), просмотра информации о подключении и настройки базы данных. Поддерживает полнотекстовый поиск (FTS5) с использованием SQLite, улучшенный алгоритм поиска с учётом опечаток и словоформ, а также отображает геолокационные данные на интерактивной карте.

Проект распространяется под лицензией Mozilla Public License 2.0.

## Возможности

- **Улучшенный поиск**:
  - Полнотекстовый поиск с использованием SQLite FTS5, дополненный алгоритмом Левенштейна для обработки опечаток (до 2 замен или 1/3 длины слова).
  - Поддержка словоформ для однословных запросов (например, для русского языка: -а, -у, -е, -ом, -ым, -и, -ей, -ям, -ями).
  - Проверка близости слов в предложении (максимальное расстояние — 2 позиции) для повышения точности.
  - Кэширование результатов поиска в `localStorage` для оптимизации повторных запросов.
  - Метрика схожести (`similarity`) для результатов поиска, отображаемая в интерфейсе.
- **Избранные сайты (плитки)**:
  - Добавление, редактирование, удаление, импорт и экспорт сайтов в формате JSON.
  - Контекстное меню для быстрого управления плитками.
- **Информация о подключении**:
  - Отображение IP-адреса, страны, города (если доступно) и интерактивной карты с использованием Leaflet.js.
- **Настройка базы данных**:
  - Поддержка локальных файлов TXT или CSV в качестве источников данных.
  - Инициализация и обновление базы данных SQLite в памяти (`restricted.db`).
  - Хранение настроек в `settings.json` в корневой папке с синхронизацией в `chrome.storage.local`.
- **Проверка обновлений**:
  - Автоматическая проверка обновлений на GitHub при включённой опции `auto_update` в настройках.
  - Ручная проверка обновлений через интерфейс настроек.
- **История поиска**:
  - Сохранение до 5 последних запросов с возможностью их просмотра и очистки.
- **Современный интерфейс**:
  - Адаптивный дизайн с тёмной темой, вдохновлённой Tailwind CSS:
    - Заголовок в почти белом цвете (`#e5e7eb`) для читаемости.
    - Сообщение «Запрос безопасен» в зелёном цвете (`#22c55e`) для подчёркивания безопасности.
    - Кнопки в сером цвете (`#4b5563`, hover: `#374151`) для гармоничного вида.
    - Иконка лупы в качестве favicon для расширения.
  - Ссылки на поисковые системы (Google, Yandex, DuckDuckGo, Startpage, Swisscows) для безопасных запросов.
- **Кроссбраузерная совместимость**:
  - Работает в браузерах на основе Chromium (Chrome, Edge) и Firefox.

## Установка

### Требования

- Современный веб-браузер (Google Chrome, Microsoft Edge или Firefox).
- Дополнительные серверные зависимости не требуются, так как расширение работает полностью в браузере.

### Настройка

1. **Клонирование репозитория**:

   ```bash
   git clone https://github.com/berkutsolutions/berkut-security-search.git
   cd berkut-security-search
   ```

2. **Подготовка базы данных**:

   - Поместите данные о запрещённых материалах в `data/fs_em.csv` (формат: `№`, `Материал`, `Дата включения`) или `data/fs_em.txt` (разделитель: «Экстремистский материал №»).
   - Расширение использует `sql-wasm.js` для инициализации базы SQLite в памяти (`restricted.db`) из этих файлов.

3. **Настройка `settings.json`**:

   - Убедитесь, что в корневой папке присутствует файл `settings.json` с настройками, например:
     ```json
     {
       "db_source": "txt",
       "db_path": "",
       "hash": "",
       "auto_update": true
     }
     ```

4. **Загрузка расширения**:

   - **Chrome/Edge**:
     1. Откройте `chrome://extensions/` в браузере.
     2. Включите **Режим разработчика** (переключатель в правом верхнем углу).
     3. Нажмите **Загрузить распакованное расширение** и выберите папку `berkut-security-search`.
   - **Firefox**:
     1. Откройте `about:debugging#/runtime/this-firefox` в Firefox.
     2. Нажмите **Загрузить временное дополнение** и выберите файл `manifest.json` в папке `berkut-security-search`.

5. **Проверка установки**:

   - Иконка расширения (лупа) должна появиться в панели инструментов браузера.
   - Нажмите на иконку, чтобы открыть всплывающее окно расширения (`index.html`).

### Структура файлов

- `manifest.json`: Файл конфигурации расширения.
- `settings.json`: Файл настроек в корневой папке, содержащий параметры базы данных и автообновления.
- `index.html`: Основной интерфейс всплывающего окна расширения.
- `css/`
  - `styles.css`: Пользовательские стили интерфейса (тёмная тема, вдохновлённая Tailwind).
  - `leaflet.css`: Стили для интерактивной карты.
- `js/`
  - `background.js`: Обработка фоновых задач и жизненного цикла расширения.
  - `db.js`: Инициализация и управление запросами к базе данных SQLite.
  - `main.js`: Основная логика обработки запросов, управления плитками и взаимодействия с интерфейсом.
  - `map.js`: Обработка геолокации и рендеринг карты с Leaflet.js.
  - `tiles.js`: Управление функциональностью избранных сайтов (плиток).
  - `sql-wasm.js` и `sql-wasm.wasm`: WebAssembly-версия SQLite для работы с базой данных в браузере.
- `data/`
  - `fs_em.csv` / `fs_em.txt`: Файлы данных о запрещённых материалах (не включены в репозиторий).
- `icons/`
  - `icon16.png`, `icon32.png`, `icon48.png`, `icon128.png`: Иконки расширения для разных размеров.

## Использование

1. **Открытие расширения**:
   - Нажмите на иконку расширения в панели инструментов браузера, чтобы открыть всплывающее окно.
2. **Управление плитками**:
   - Добавляйте сайты через кнопку **Добавить сайт**.
   - Щёлкните правой кнопкой мыши по плитке для редактирования или удаления.
   - Импортируйте/экспортируйте плитки с помощью кнопок **Импорт плиток** и **Экспорт плиток** (формат JSON).
3. **Поиск запросов**:
   - Введите запрос в строку поиска и нажмите **Поиск**.
   - Во время проверки отображается индикатор выполнения.
   - Безопасные запросы показывают сообщение «Запрос безопасен!» с ссылками на Google, Yandex, DuckDuckGo, Startpage и Swisscows.
   - Запрещённые запросы отображают предупреждение с деталями (ID, дата, причина, степень соответствия) в модальном окне.
4. **Настройки**:
   - Настройте источник базы данных (TXT или CSV) через модальное окно настроек.
   - Включите/отключите автоматическую проверку обновлений с GitHub.
   - Очистите историю поиска с помощью кнопки **Очистить историю**.
5. **Информация о подключении**:
   - Просмотрите IP-адрес, страну, город и интерактивную карту в правой колонке.

## Замечания по безопасности

- **Конфиденциальность данных**: Расширение обрабатывает данные локально в браузере с использованием WebAssembly SQLite, не отправляя запросы на внешние серверы (кроме проверки обновлений на GitHub и геолокации).
- **Геолокация**: Использует API геолокации (`ip-api.com`) для безопасного отображения данных о подключении.
- **Разрешения**: Запрашивает минимальные разрешения (`storage`, `activeTab`), снижая риски безопасности.
- **Санитизация ввода**: Проверяет и очищает пользовательский ввод для предотвращения XSS-атак при обработке запросов и управлении плитками.
- **Проверка обновлений**: Использует API GitHub для проверки новых версий, обеспечивая актуальность расширения.

## Лицензия

Распространяется под лицензией Mozilla Public License 2.0. Подробности: https://mozilla.org/MPL/2.0/.

## Контакты

Для вопросов или предложений создайте issue на GitHub: https://github.com/berkutsolutions/berkut-security-search.
